name: CI TEST

on:
  push:
    # branches: [ main ] 確認の為、コメントアウト
  pull_request:

permissions:
  contents: read
  checks: write # テスト結果をPRに表示したい場合

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # localstack docker
    services:
      localstack:
        image: localstack/localstack:4.11.1
        ports: [4567:4566]
        env:
          SERVICES: dynamodb
          DEBUG: 0
          PERSISTENCE: 0

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install pnpm
        run: npm install -g pnpm@latest

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: LocalStack 起動待機
        run: npx wait-on http-get://localhost:4567/_localstack/health --timeout 60000

      - name: テスト実行
        env:
          NODE_ENV: test
          BACKEND_PREFIX: api
          BACKEND_PORT: 3001
          BACKEND_LOG_LEVEL: silent
          BACKEND_CORS_ORIGIN: http://localhost:3000,http://127.0.0.1:3000
          INVITATION_LOG_LEVEL: silent
          INVITATION_LINK_ORIGIN: http://localhost:3000
          INVITATION_RETRY_TIMEOUT: 1
          AWS_ACCESS_KEY_ID: dummy
          AWS_SECRET_ACCESS_KEY: dummy
          AWS_REGION: ap-northeast-1
          AWS_DYNAMO_ENDPOINT: http://localhost:4567
          AWS_DYNAMO_TASK_TABLE: task-table-v3
          AWS_DYNAMO_INVITATION_TABLE: task-table-invitation-v3
          AWS_COGNITO_USER_POOL_ID: ap-northeast-1_test
          AWS_COGNITO_CLIENT_ID: test_client_id
          AWS_SNS_ENDPOINT: http://localhost:4567
          AWS_SNS_TOPIC_ARN: aws_sns_topc_arn
        run: pnpm turbo run test:ci --output-logs=errors-only
